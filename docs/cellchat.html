<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Macrophage Pathway Changes: LM vs AN</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #2d3748;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 40px;
            text-align: center;
        }

        h1 {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 1.05rem;
            opacity: 0.95;
            font-weight: 300;
        }

        .controls {
            padding: 25px 30px;
            background: #f7fafc;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .control-group label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #4a5568;
        }

        select,
        input {
            padding: 8px 14px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
            transition: all 0.2s;
        }

        select:focus,
        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 9px 18px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .waterfalls-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
            padding: 30px;
        }

        .waterfall-section {
            background: white;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            overflow: hidden;
        }

        .waterfall-title {
            background: #f7fafc;
            padding: 15px 20px;
            font-weight: 600;
            font-size: 1.05rem;
            color: #2d3748;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pathway-count {
            font-size: 0.85rem;
            color: #718096;
            font-weight: 500;
        }

        .waterfall-content {
            padding: 20px;
            overflow-y: auto;
            max-height: 700px;
        }

        .bar {
            cursor: pointer;
            transition: all 0.2s;
        }

        .bar:hover {
            opacity: 0.8;
            stroke: #1a202c;
            stroke-width: 2;
        }

        .bar.highlighted {
            stroke: #f59e0b;
            stroke-width: 3;
        }

        .axis text {
            font-size: 11px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .axis-label {
            font-weight: 600;
            font-size: 12px;
        }

        .zero-line {
            stroke: #4a5568;
            stroke-width: 2;
            stroke-dasharray: 5, 5;
        }

        .legend {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px 30px;
            background: #f7fafc;
            border-top: 2px solid #e2e8f0;
            flex-wrap: wrap;
        }

        .legend-title {
            font-weight: 600;
            margin-right: 10px;
            font-size: 0.95rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .legend-box {
            width: 30px;
            height: 15px;
            border-radius: 3px;
        }

        .tooltip {
            position: absolute;
            padding: 12px 16px;
            background: rgba(26, 32, 44, 0.96);
            color: white;
            border-radius: 6px;
            font-size: 0.85rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
            max-width: 320px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            line-height: 1.5;
        }

        .tooltip.show {
            opacity: 1;
        }

        .tooltip-pathway {
            font-weight: 700;
            font-size: 0.95rem;
            margin-bottom: 8px;
            color: #fbbf24;
        }

        .tooltip-row {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin: 4px 0;
        }

        .tooltip-label {
            color: #cbd5e0;
        }

        .tooltip-value {
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 60px;
            font-size: 1.1rem;
            color: #718096;
        }

        .value-display {
            font-size: 0.75rem;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>CellChat Pathway Analysis</h1>
            <div class="subtitle">Cell-Cell Communication: Liver Metastasis vs Adjacent Normal</div>
        </header>

        <div class="controls">
            <div class="control-group">
                <label for="cellType">Cell Type:</label>
                <select id="cellType">
                    <option value="All" selected>All Cell Types (Average)</option>
                </select>
            </div>

            <div class="control-group">
                <label for="minChange">Min % Change:</label>
                <input type="number" id="minChange" min="0" max="500" step="5" value="10" style="width: 100px;">
            </div>

            <div class="control-group">
                <label for="maxChange">Max % Change:</label>
                <input type="number" id="maxChange" min="0" max="1000" step="10" value="1000" style="width: 110px;">
            </div>

            <div class="control-group">
                <label for="topN">Top N Pathways:</label>
                <select id="topN">
                    <option value="10">Top 10</option>
                    <option value="20">Top 20</option>
                    <option value="30" selected>Top 30</option>
                    <option value="50">Top 50</option>
                    <option value="1000">All</option>
                </select>
            </div>

            <div class="control-group">
                <label for="direction">Show:</label>
                <select id="direction">
                    <option value="all">All Changes</option>
                    <option value="gain">Gains Only (LM > AN)</option>
                    <option value="loss">Losses Only (LM < AN)</option>
                </select>
            </div>

            <button class="btn" onclick="resetFilters()">Reset Filters</button>
        </div>

        <div class="waterfalls-container" id="waterfalls">
            <div class="loading">Loading CellChat data...</div>
        </div>

        <div class="legend">
            <span class="legend-title">Color Legend:</span>
            <div class="legend-item">
                <div class="legend-box" style="background: #10b981;"></div>
                <span>Gained in Liver Metastasis (LM > AN)</span>
            </div>
            <div class="legend-item">
                <div class="legend-box" style="background: #ef4444;"></div>
                <span>Lost in Liver Metastasis (LM < AN)</span>
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        let datasets = {
            incomingAN: null,
            outgoingAN: null,
            incomingLM: null,
            outgoingLM: null
        };

        let cellTypes = [];
        let cellTypeChanges = null;
        let selectedPathway = null;

        async function loadData() {
            try {
                const [incomingAN, outgoingAN, incomingLM, outgoingLM] = await Promise.all([
                    d3.csv('data/cellchat/incomingPathwaysAN.csv'),
                    d3.csv('data/cellchat/outgoingPathwaysAN.csv'),
                    d3.csv('data/cellchat/incomingPathwaysLM.csv'),
                    d3.csv('data/cellchat/outgoingPathwaysLM.csv')
                ]);

                datasets.incomingAN = incomingAN;
                datasets.outgoingAN = outgoingAN;
                datasets.incomingLM = incomingLM;
                datasets.outgoingLM = outgoingLM;

                // Extract cell types from data
                cellTypes = Object.keys(incomingAN[0]).filter(k => k !== '');

                // Populate cell type dropdown
                const cellTypeSelect = document.getElementById('cellType');
                cellTypes.forEach(ct => {
                    const option = document.createElement('option');
                    option.value = ct;
                    option.textContent = ct;
                    cellTypeSelect.appendChild(option);
                });

                calculateCellTypeChanges();
                renderWaterfalls();

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('waterfalls').innerHTML =
                    '<div class="loading" style="color: #f56565;">Error loading data. Please check file paths.</div>';
            }
        }

        function calculateCellTypeChanges() {
            const pathways = datasets.incomingAN.map(d => d['']).filter(p => p);
            const selectedCellType = document.getElementById('cellType').value;

            cellTypeChanges = {
                incoming: [],
                outgoing: []
            };

            pathways.forEach(pathway => {
                let anIn, lmIn, anOut, lmOut;

                if (selectedCellType === 'All') {
                    // Average across all cell types
                    const incomingRow = datasets.incomingAN.find(d => d[''] === pathway);
                    const incomingLMRow = datasets.incomingLM.find(d => d[''] === pathway);
                    const outgoingRow = datasets.outgoingAN.find(d => d[''] === pathway);
                    const outgoingLMRow = datasets.outgoingLM.find(d => d[''] === pathway);

                    anIn = cellTypes.reduce((sum, ct) => sum + (parseFloat(incomingRow?.[ct]) || 0), 0) / cellTypes.length;
                    lmIn = cellTypes.reduce((sum, ct) => sum + (parseFloat(incomingLMRow?.[ct]) || 0), 0) / cellTypes.length;
                    anOut = cellTypes.reduce((sum, ct) => sum + (parseFloat(outgoingRow?.[ct]) || 0), 0) / cellTypes.length;
                    lmOut = cellTypes.reduce((sum, ct) => sum + (parseFloat(outgoingLMRow?.[ct]) || 0), 0) / cellTypes.length;
                } else {
                    // Specific cell type
                    anIn = parseFloat(datasets.incomingAN.find(d => d[''] === pathway)?.[selectedCellType]) || 0;
                    lmIn = parseFloat(datasets.incomingLM.find(d => d[''] === pathway)?.[selectedCellType]) || 0;
                    anOut = parseFloat(datasets.outgoingAN.find(d => d[''] === pathway)?.[selectedCellType]) || 0;
                    lmOut = parseFloat(datasets.outgoingLM.find(d => d[''] === pathway)?.[selectedCellType]) || 0;
                }

                if (anIn > 0 || lmIn > 0) {
                    const change = lmIn - anIn;
                    const percentChange = anIn > 0 ? (change / anIn) * 100 : (lmIn > 0 ? 100 : 0);

                    cellTypeChanges.incoming.push({
                        pathway,
                        an: anIn,
                        lm: lmIn,
                        change: change,
                        percentChange: percentChange,
                        foldChange: anIn > 0 ? lmIn / anIn : (lmIn > 0 ? Infinity : 0)
                    });
                }

                if (anOut > 0 || lmOut > 0) {
                    const change = lmOut - anOut;
                    const percentChange = anOut > 0 ? (change / anOut) * 100 : (lmOut > 0 ? 100 : 0);

                    cellTypeChanges.outgoing.push({
                        pathway,
                        an: anOut,
                        lm: lmOut,
                        change: change,
                        percentChange: percentChange,
                        foldChange: anOut > 0 ? lmOut / anOut : (lmOut > 0 ? Infinity : 0)
                    });
                }
            });

            // Sort by percent change: positive (gains) first, descending
            cellTypeChanges.incoming.sort((a, b) => b.percentChange - a.percentChange);
            cellTypeChanges.outgoing.sort((a, b) => b.percentChange - a.percentChange);
        }

        function filterData(data) {
            const minChange = parseFloat(document.getElementById('minChange').value);
            const maxChange = parseFloat(document.getElementById('maxChange').value);
            const topN = parseInt(document.getElementById('topN').value);
            const direction = document.getElementById('direction').value;

            let filtered = data.filter(d => {
                const absChange = Math.abs(d.percentChange);
                return absChange >= minChange && absChange <= maxChange;
            });

            if (direction === 'gain') {
                filtered = filtered.filter(d => d.change > 0);
            } else if (direction === 'loss') {
                filtered = filtered.filter(d => d.change < 0);
            }

            return filtered.slice(0, topN);
        }

        function renderWaterfalls() {
            const container = document.getElementById('waterfalls');
            container.innerHTML = '';

            const selectedCellType = document.getElementById('cellType').value;
            const incomingFiltered = filterData(cellTypeChanges.incoming);
            const outgoingFiltered = filterData(cellTypeChanges.outgoing);

            renderWaterfall(incomingFiltered, 'incoming-waterfall',
                'Incoming Pathways', 'What Macrophages Receive');
            renderWaterfall(outgoingFiltered, 'outgoing-waterfall',
                'Outgoing Pathways', 'What Macrophages Send');
        }

        function renderWaterfall(data, containerId, title, subtitle) {
            if (data.length === 0) {
                const section = document.createElement('div');
                section.className = 'waterfall-section';
                section.innerHTML = `
                    <div class="waterfall-title">${title}</div>
                    <div class="loading" style="padding: 40px;">No pathways match current filters</div>
                `;
                document.getElementById('waterfalls').appendChild(section);
                return;
            }

            const margin = { top: 20, right: 100, bottom: 40, left: 150 };
            const barHeight = 22;
            const height = data.length * barHeight + margin.top + margin.bottom;
            const width = 700;

            const section = document.createElement('div');
            section.className = 'waterfall-section';
            section.innerHTML = `
                <div class="waterfall-title">
                    ${title}
                    <span class="pathway-count">${data.length} pathways</span>
                </div>
                <div class="waterfall-content" id="${containerId}"></div>
            `;
            document.getElementById('waterfalls').appendChild(section);

            const svg = d3.select(`#${containerId}`)
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Scales
            const maxAbsChange = d3.max(data, d => Math.abs(d.percentChange));
            const xScale = d3.scaleLinear()
                .domain([-maxAbsChange, maxAbsChange])
                .range([0, width - margin.left - margin.right]);

            const yScale = d3.scaleBand()
                .domain(data.map(d => d.pathway))
                .range([0, data.length * barHeight])
                .padding(0.15);

            // Zero line
            g.append('line')
                .attr('class', 'zero-line')
                .attr('x1', xScale(0))
                .attr('x2', xScale(0))
                .attr('y1', 0)
                .attr('y2', data.length * barHeight);

            // Bars
            g.selectAll('.bar')
                .data(data)
                .enter()
                .append('rect')
                .attr('class', d => `bar pathway-${d.pathway.replace(/[^a-zA-Z0-9]/g, '_')}`)
                .attr('x', d => d.percentChange > 0 ? xScale(0) : xScale(d.percentChange))
                .attr('y', d => yScale(d.pathway))
                .attr('width', d => Math.abs(xScale(d.percentChange) - xScale(0)))
                .attr('height', yScale.bandwidth())
                .attr('fill', d => d.percentChange > 0 ? '#10b981' : '#ef4444')
                .on('mouseover', (event, d) => showTooltip(event, d))
                .on('mouseout', hideTooltip)
                .on('click', (event, d) => selectPathway(d.pathway));

            // Value labels
            g.selectAll('.value-label')
                .data(data)
                .enter()
                .append('text')
                .attr('class', 'value-display')
                .attr('x', d => d.percentChange > 0 ?
                    xScale(d.percentChange) + 5 : xScale(d.percentChange) - 5)
                .attr('y', d => yScale(d.pathway) + yScale.bandwidth() / 2 + 4)
                .attr('text-anchor', d => d.percentChange > 0 ? 'start' : 'end')
                .attr('fill', '#1a202c')
                .text(d => `${d.percentChange > 0 ? '+' : ''}${d.percentChange.toFixed(1)}%`);

            // Y-axis (pathway labels)
            g.selectAll('.pathway-label')
                .data(data)
                .enter()
                .append('text')
                .attr('class', 'axis')
                .attr('x', -10)
                .attr('y', d => yScale(d.pathway) + yScale.bandwidth() / 2 + 4)
                .attr('text-anchor', 'end')
                .text(d => d.pathway)
                .style('font-size', '10px')
                .style('cursor', 'pointer')
                .on('click', (event, d) => selectPathway(d.pathway));

            // X-axis
            const xAxis = d3.axisBottom(xScale)
                .ticks(5)
                .tickFormat(d => `${d}%`);

            g.append('g')
                .attr('class', 'axis')
                .attr('transform', `translate(0,${data.length * barHeight})`)
                .call(xAxis);

            // X-axis label
            g.append('text')
                .attr('class', 'axis-label')
                .attr('x', (width - margin.left - margin.right) / 2)
                .attr('y', data.length * barHeight + 35)
                .attr('text-anchor', 'middle')
                .text('% Change (LM vs AN)');
        }

        function showTooltip(event, d) {
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = `
                <div class="tooltip-pathway">${d.pathway}</div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Adjacent Normal:</span>
                    <span class="tooltip-value">${d.an.toFixed(3)}</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Liver Metastasis:</span>
                    <span class="tooltip-value">${d.lm.toFixed(3)}</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Change:</span>
                    <span class="tooltip-value" style="color: ${d.change > 0 ? '#10b981' : '#ef4444'}">
                        ${d.change > 0 ? '+' : ''}${d.change.toFixed(3)}
                    </span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">% Change:</span>
                    <span class="tooltip-value" style="color: ${d.percentChange > 0 ? '#10b981' : '#ef4444'}">
                        ${d.percentChange > 0 ? '+' : ''}${d.percentChange.toFixed(1)}%
                    </span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Fold Change:</span>
                    <span class="tooltip-value">${d.foldChange === Infinity ? 'âˆž' : d.foldChange.toFixed(2)}x</span>
                </div>
            `;
            tooltip.style.left = (event.pageX + 15) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
            tooltip.classList.add('show');
        }

        function hideTooltip() {
            document.getElementById('tooltip').classList.remove('show');
        }

        function selectPathway(pathway) {
            selectedPathway = pathway;
            d3.selectAll('.bar').classed('highlighted', false);
            d3.selectAll(`.pathway-${pathway.replace(/[^a-zA-Z0-9]/g, '_')}`).classed('highlighted', true);
        }

        function resetFilters() {
            document.getElementById('cellType').value = 'All';
            document.getElementById('minChange').value = '10';
            document.getElementById('maxChange').value = '1000';
            document.getElementById('topN').value = '30';
            document.getElementById('direction').value = 'all';
            selectedPathway = null;
            d3.selectAll('.bar').classed('highlighted', false);
            calculateCellTypeChanges();
            renderWaterfalls();
        }

        // Event listeners
        document.getElementById('cellType').addEventListener('change', () => {
            calculateCellTypeChanges();
            renderWaterfalls();
        });
        document.getElementById('minChange').addEventListener('change', renderWaterfalls);
        document.getElementById('maxChange').addEventListener('change', renderWaterfalls);
        document.getElementById('topN').addEventListener('change', renderWaterfalls);
        document.getElementById('direction').addEventListener('change', renderWaterfalls);

        // Initialize
        loadData();
    </script>
</body>

</html>
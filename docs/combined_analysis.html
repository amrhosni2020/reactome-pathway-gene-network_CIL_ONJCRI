<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Macrophage Combined Analysis: Inversion & Reactome</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent: #818cf8;
            --border: #334155;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        header {
            background: var(--bg-secondary);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 1.25rem;
            font-weight: 600;
            background: linear-gradient(to right, #818cf8, #c084fc);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Layout */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar (Controls & Lists) */
        .sidebar {
            width: 400px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .controls {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .control-group {
            margin-bottom: 1rem;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
        }

        select,
        input {
            width: 100%;
            padding: 0.5rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 0.375rem;
        }

        .list-header {
            padding: 1rem 1.5rem;
            background: rgba(0, 0, 0, 0.2);
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
        }

        .pathway-list {
            flex: 1;
            overflow-y: auto;
        }

        .pathway-item {
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pathway-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .pathway-item.active {
            background: rgba(129, 140, 248, 0.1);
            border-left: 3px solid var(--accent);
        }

        .pathway-name {
            font-weight: 500;
        }

        .pathway-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .tag {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            background: var(--bg-primary);
        }

        /* Visualization Area */
        .viz-area {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .panel {
            background: var(--bg-secondary);
            border-radius: 0.75rem;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .panel-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
        }

        .panel-body {
            padding: 1.5rem;
            min-height: 400px;
            position: relative;
        }

        /* D3 Styles */
        .node circle {
            stroke: #fff;
            stroke-width: 1.5px;
        }

        .link {
            fill: none;
            stroke-opacity: 0.4;
            transition: stroke-opacity 0.2s;
        }

        .link:hover {
            stroke-opacity: 0.8;
        }

        text {
            font-size: 10px;
            fill: var(--text-secondary);
        }

        .loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(15, 23, 42, 0.8);
            z-index: 100;
            flex-direction: column;
            gap: 1rem;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            padding: 0.75rem;
            border-radius: 0.5rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            z-index: 50;
            max-width: 300px;
        }

        .tooltip h4 {
            color: var(--accent);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .tooltip p {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }
    </style>
</head>

<body>

    <header>
        <h1>Combined Analysis Dashboard</h1>
        <div style="font-size: 0.9rem; color: var(--text-secondary);">
            Reactome Enrichment â€¢ CellChat Inversion
        </div>
    </header>

    <div class="main-container">
        <div class="sidebar">
            <div class="controls">
                <div class="control-group">
                    <label>Inversion Set</label>
                    <select id="inversionSelect">
                        <option value="sgp_down_human_up">Sgp Down / Human Up</option>
                        <option value="sgp_up_human_down">Sgp Up / Human Down</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Filter Pathways</label>
                    <input type="text" id="pathwaySearch" placeholder="Search pathways (e.g. TNF)...">
                </div>
            </div>

            <div class="list-header">
                <span>Enriched Pathways</span>
                <span>p-adj</span>
            </div>
            <div class="pathway-list" id="pathwayList">
                <!-- Items injected by JS -->
            </div>
        </div>

        <div class="viz-area">
            <div class="panel">
                <div class="panel-header">
                    <span>Network Visualization</span>
                    <span id="selectedPathwayTitle" style="color: var(--accent);">Select a pathway</span>
                </div>
                <div class="panel-body" id="networkViz">
                    <div class="loading" id="loader">
                        <div class="spinner"></div>
                        <div>Loading Analysis Data...</div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">Gene Details</div>
                <div class="panel-body" id="geneDetails" style="min-height: 200px;">
                    <div style="color: var(--text-secondary); text-align: center; margin-top: 2rem;">
                        Click a node in the network to view details
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        let rawData = null;
        let currentInversion = "sgp_down_human_up";
        let currentPathway = null;

        // Load Data
        d3.json('./data/combined_analysis.json').then(data => {
            rawData = data;
            document.getElementById('loader').style.display = 'none';

            // Log data for debugging
            console.log("Loaded Data:", data);

            initDashboard();
        }).catch(err => {
            console.error(err);
            document.getElementById('loader').innerHTML = `<div style="color: var(--danger)">Error loading data: ${err.message}</div>`;
        });

        function initDashboard() {
            // Setup listeners
            document.getElementById('inversionSelect').addEventListener('change', (e) => {
                currentInversion = e.target.value;
                renderPathwayList();
            });

            document.getElementById('pathwaySearch').addEventListener('input', renderPathwayList);

            renderPathwayList();
        }

        function renderPathwayList() {
            const listEl = document.getElementById('pathwayList');
            const search = document.getElementById('pathwaySearch').value.toLowerCase();

            if (!rawData.inversion_enrichment || rawData.inversion_enrichment.length === 0) {
                listEl.innerHTML = '<div style="padding:1.5rem; color:var(--text-secondary)">No enrichment data found.</div>';
                return;
            }

            let items = rawData.inversion_enrichment.filter(d =>
                d.inversion_group.includes(currentInversion) &&
                d.p_adj < 0.05
            );

            // Deduplicate by pathway (taking best p-val if multiple datasets)
            const uniqueItems = {};
            items.forEach(d => {
                if (!uniqueItems[d.pathway] || d.p_adj < uniqueItems[d.pathway].p_adj) {
                    uniqueItems[d.pathway] = d;
                }
            });
            items = Object.values(uniqueItems);

            // Search filter
            if (search) {
                items = items.filter(d => d.pathway.toLowerCase().includes(search));
            }

            // Sort by significance
            items.sort((a, b) => a.p_adj - b.p_adj);

            listEl.innerHTML = '';
            items.forEach(d => {
                const div = document.createElement('div');
                div.className = `pathway-item ${currentPathway === d.pathway ? 'active' : ''}`;
                div.innerHTML = `
                <span class="pathway-name">${d.pathway}</span>
                <span class="tag">${d.p_adj.toExponential(1)}</span>
            `;
                div.onclick = () => selectPathway(d.pathway);
                listEl.appendChild(div);
            });
        }

        function selectPathway(pathwayName) {
            currentPathway = pathwayName;
            document.getElementById('selectedPathwayTitle').textContent = pathwayName;
            renderPathwayList(); // To update active class
            renderNetwork(pathwayName);
        }

        function renderNetwork(pathwayName) {
            const container = document.getElementById('networkViz');
            container.innerHTML = '';

            const width = container.clientWidth;
            const height = container.clientHeight;

            const svg = d3.select(container).append('svg')
                .attr('width', width)
                .attr('height', height);

            // Build Graph Data
            const enrichEntries = rawData.inversion_enrichment.filter(d =>
                d.pathway === pathwayName && d.inversion_group.includes(currentInversion)
            );

            const overlapGenes = new Set();
            enrichEntries.forEach(d => {
                d.overlap_genes.split(';').forEach(g => overlapGenes.add(g));
            });

            // Get Reactome terms enriched in this inversion set
            const reactomeTerms = rawData.reactome_enrichment.filter(d =>
                d.group_name.includes(currentInversion) && d.p_adjust < 0.05
            ).slice(0, 10); // Top 10

            // Nodes
            const nodes = [];
            const links = [];

            // Center Node: The Pathway
            nodes.push({ id: pathwayName, type: 'pathway', r: 20 });

            // Gene Nodes (Only overlapping ones)
            overlapGenes.forEach(gene => {
                nodes.push({ id: gene, type: 'gene', r: 8 });
                links.push({ source: pathwayName, target: gene });
            });

            // Reactome Nodes (Optional visualization)
            reactomeTerms.forEach(term => {
                // Logic to link genes to Reactome terms would go here
                // For now, we visualize specific L-R interactions within the inversion set
            });

            // Simulation
            const simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(d => d.id).distance(100))
                .force("charge", d3.forceManyBody().strength(-300))
                .force("center", d3.forceCenter(width / 2, height / 2));

            const link = svg.append("g")
                .selectAll("line")
                .data(links)
                .join("line")
                .attr("class", "link")
                .attr("stroke", "#999");

            const node = svg.append("g")
                .selectAll("circle")
                .data(nodes)
                .join("circle")
                .attr("r", d => d.r)
                .attr("fill", d => d.type === 'pathway' ? '#f59e0b' : '#818cf8')
                .call(drag(simulation));

            const label = svg.append("g")
                .selectAll("text")
                .data(nodes)
                .join("text")
                .text(d => d.id)
                .attr("dx", 12)
                .attr("dy", 4);

            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node
                    .attr("cx", d => d.x)
                    .attr("cy", d => d.y);

                label
                    .attr("x", d => d.x)
                    .attr("y", d => d.y);
            });

            // Click handler
            node.on('click', (event, d) => {
                showGeneDetails(d);
            });
        }

        function showGeneDetails(node) {
            const el = document.getElementById('geneDetails');
            if (node.type === 'gene') {
                const info = rawData.inversion_genes.find(g => g.gene === node.id && g.inversion_type.includes(currentInversion));

                el.innerHTML = `
                <h3 style="color:var(--accent); margin-bottom:1rem;">${node.id}</h3>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; font-size:0.9rem;">
                    <div>
                        <div style="color:var(--text-secondary)">Mouse (Sgp vs WT) LogFC</div>
                        <div style="font-size:1.2rem; color:${info?.Sgp_avg_log2FC > 0 ? 'var(--danger)' : 'var(--success)'}">
                            ${info?.Sgp_avg_log2FC?.toFixed(2) || 'N/A'}
                        </div>
                    </div>
                    <div>
                        <div style="color:var(--text-secondary)">Human (LM vs Normal) LogFC</div>
                        <div style="font-size:1.2rem; color:${info?.Human_avg_log2FC.y > 0 ? 'var(--danger)' : 'var(--success)'}">
                            ${info?.Human_avg_log2FC.y?.toFixed(2) || 'N/A'}
                        </div>
                    </div>
                </div>
            `;
            } else {
                el.innerHTML = `<div style="padding:1rem;">${node.id}</div>`;
            }
        }

        // Drag helpers
        function drag(simulation) {
            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }
            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }
            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }
            return d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended);
        }

    </script>
</body>

</html>
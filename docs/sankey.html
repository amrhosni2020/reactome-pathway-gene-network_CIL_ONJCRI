<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sankey Diagram | CellChat Analysis</title>
    <!-- Load D3.js and d3-sankey -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <style>
        :root {
            --bg-color: #0f172a;
            --panel-bg: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --accent-color: #3b82f6;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            padding: 20px 40px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(to right, #818cf8, #c084fc);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .back-link {
            text-decoration: none;
            color: var(--text-secondary);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.2s;
        }

        .back-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar Controls */
        .sidebar {
            width: 350px;
            background-color: var(--panel-bg);
            border-right: 1px solid var(--border-color);
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .control-group label {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        input[type="range"] {
            width: 100%;
            accent-color: var(--accent-color);
        }

        /* Checkbox Style */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            transition: background 0.2s;
        }

        .checkbox-wrapper:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-color);
            cursor: pointer;
        }

        .chart-area {
            flex: 1;
            padding: 20px;
            overflow: auto;
            position: relative;
        }

        #sankeySvg {
            width: 100%;
            height: 100%;
            min-height: 600px;
        }

        .node rect {
            cursor: pointer;
            fill-opacity: 0.9;
        }

        .node rect:hover {
            fill-opacity: 1;
            stroke: white;
            stroke-width: 1px;
        }

        .node circle {
            cursor: pointer;
            stroke: #fff;
            stroke-width: 1px;
        }

        .node circle:hover {
            stroke-width: 2px;
        }

        .link {
            fill: none;
            stroke-opacity: 0.3;
            transition: stroke-opacity 0.2s;
        }

        .link:hover {
            stroke-opacity: 0.6;
        }

        .node text {
            font-size: 12px;
            fill: var(--text-primary);
            pointer-events: none;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
        }

        .legend {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .color-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        /* Column Headers */
        .column-header {
            font-size: 14px;
            font-weight: bold;
            fill: #94a3b8;
            text-anchor: middle;
        }

        .column-sub {
            font-size: 11px;
            fill: #64748b;
            font-weight: normal;
        }
    </style>
</head>

<body>

    <header>
        <div>
            <h1>Effect → Process → CellChat Pathway → Gene</h1>
            <div class="subtitle">Mapping Gene Signatures to Functional Hubs</div>
        </div>
        <a href="index.html" class="back-link">← Back to Dashboard</a>
    </header>

    <div class="main-container">
        <div class="sidebar">

            <div class="control-group">
                <label>Visualization Controls</label>
                <div>
                    <span style="font-size:0.8rem; color:var(--text-secondary)">Node Padding</span>
                    <input type="range" id="nodePad" min="5" max="50" value="15" oninput="updateChart()">
                </div>
                <div>
                    <span style="font-size:0.8rem; color:var(--text-secondary)">Link Opacity</span>
                    <input type="range" id="linkOpacity" min="0.1" max="0.8" step="0.1" value="0.3"
                        oninput="updateChart()">
                </div>
                <div>
                    <span style="font-size:0.8rem; color:var(--text-secondary)">Chart Height</span>
                    <input type="range" id="chartHeight" min="600" max="2500" step="50" value="800"
                        oninput="resizeChart()">
                </div>
            </div>

            <div class="control-group">
                <label>Features</label>
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="fcMode" onchange="updateChart()">
                    <div>
                        <span style="display:block; font-weight:600; font-size:0.9rem;">Fold Change Size</span>
                        <span style="font-size:0.75rem; color:var(--text-secondary)">Size Genes by Expression FC</span>
                    </div>
                </div>
            </div>

            <div class="legend" id="legendContainer">
                <label style="margin-bottom:10px; display:block">Signature Categories</label>
                <div class="legend-item">
                    <div class="color-dot" style="background: #e74c3c"></div>
                    (Pro-Tumour)
                </div>
                <div class="legend-item">
                    <div class="color-dot" style="background: #27ae60"></div>
                    (Anti-Tumour)
                </div>
                <div class="legend-item">
                    <div class="color-dot" style="background: #8e44ad"></div>
                    (Hypoxia & Metabolism)
                </div>
            </div>

            <!-- Circle Size Legend (Dynamic) -->
            <div id="fcLegend"
                style="display:none; margin-top:20px; padding-top:20px; border-top:1px solid var(--border-color)">
                <label style="margin-bottom:10px; display:block">Log2 Fold Change</label>
                <div style="display:flex; align-items:center; gap:15px; color:var(--text-secondary); font-size:0.8rem;">
                    <div style="text-align:center">
                        <div style="width:6px; height:6px; background:#64748b; border-radius:50%; margin:0 auto 4px;">
                        </div>Low
                    </div>
                    <div style="text-align:center">
                        <div style="width:12px; height:12px; background:#64748b; border-radius:50%; margin:0 auto 4px;">
                        </div>Med
                    </div>
                    <div style="text-align:center">
                        <div style="width:20px; height:20px; background:#64748b; border-radius:50%; margin:0 auto 4px;">
                        </div>High
                    </div>
                </div>
            </div>

        </div>

        <div class="chart-area" id="chartContainer">
            <svg id="sankeySvg"></svg>
        </div>
    </div>

    <div id="tooltip"
        style="position: absolute; display: none; background: rgba(0, 0, 0, 0.8); color: white; padding: 8px; border-radius: 4px; pointer-events: none; font-size: 12px; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
    </div>

    <script>
        // --- Configuration ---
        const COLORS = {
            "Pro-Tumour": "#e74c3c", // Red
            "Anti-Tumour": "#27ae60", // Green
            "Metabolic": "#8e44ad",   // Purple
            "Default": "#64748b"      // Slate 500
        };

        let sankeyData = { nodes: [], links: [] };
        let geneFCMap = new Map(); // Gene -> LogFC

        const svg = d3.select("#sankeySvg");
        const container = document.getElementById("chartContainer");
        const tooltip = d3.select("#tooltip");

        // --- Data Loading ---
        async function loadData() {
            try {
                // Load Sankey Structure with cache busting
                const csvData = await d3.csv(`data/sankey_data.csv?v=${Date.now()}`);

                // Load Fold Change Data with cache busting
                const fcData = await d3.csv(`data/gene_fc.csv?v=${Date.now()}`);
                fcData.forEach(d => {
                    geneFCMap.set(d.gene, Math.abs(parseFloat(d.LogFC) || 0));
                });

                processData(csvData);
                updateChart();

            } catch (error) {
                console.error("Error:", error);
                container.innerHTML = `<div style="color:red; padding:20px">Error: ${error.message}</div>`;
            }
        }

        // --- Process Data into Nodes/Links ---
        function processData(rawData) {
            let nodes = [];
            let nodeMap = new Map();
            let links = [];

            function addNode(name, category, type) {
                const id = `${name}__${type}`;
                if (!nodeMap.has(id)) {
                    let color = COLORS.Default;
                    if (category) {
                        if (category.includes("Pro-Tumour")) color = COLORS["Pro-Tumour"];
                        else if (category.includes("Anti-Tumour")) color = COLORS["Anti-Tumour"];
                        else if (category.includes("Metabolism")) color = COLORS["Metabolic"];
                    }

                    nodes.push({ name: name, type: type, category: category, color: color, id: id });
                    nodeMap.set(id, nodes.length - 1);
                }
                return nodeMap.get(id);
            }

            rawData.forEach(row => {
                // Function to clean names (remove text in brackets but keep content if it's the only text)
                const clean = (s) => {
                    const match = s.match(/^\((.*?)\)$/);
                    if (match) return match[1].trim(); // If "(Text)", return "Text"
                    return s.replace(/\s*\(.*?\)\s*/g, '').trim(); // Remove brackets elsewhere
                };

                const sourceNameRaw = row.Source;
                const sourceNameClean = clean(row.Source);
                const processName = clean(row.Process);
                const genes = row.Genes ? row.Genes.split(',').map(s => clean(s.trim())).filter(s => s) : [];
                const hubs = row.Hubs ? row.Hubs.split(',').map(s => clean(s.trim())).filter(s => s) : [];

                // 1. Source -> Process
                const srcIdx = addNode(sourceNameClean, sourceNameRaw, "source");
                const procIdx = addNode(processName, sourceNameRaw, "process");

                links.push({ source: srcIdx, target: procIdx, value: genes.length || 1 });

                // 2. Process -> Hub (CellChat Pathway)
                hubs.forEach(hub => {
                    const hubIdx = addNode(hub, sourceNameRaw, "hub");
                    links.push({ source: procIdx, target: hubIdx, value: genes.length || 1 }); // Link weight based on associated genes

                    // 3. Hub -> Gene
                    genes.forEach(gene => {
                        const geneIdx = addNode(gene, sourceNameRaw, "gene");
                        links.push({ source: hubIdx, target: geneIdx, value: 1 });
                    });
                });
            });

            sankeyData = { nodes, links };
        }

        // --- Rendering ---
        function updateChart() {
            const width = container.clientWidth - 40;
            const height = parseInt(document.getElementById("chartHeight").value);
            const nodePad = parseInt(document.getElementById("nodePad").value);
            const fcMode = document.getElementById("fcMode").checked;
            const linkOpacity = document.getElementById("linkOpacity").value;

            // Show/Hide Legends
            document.getElementById("fcLegend").style.display = fcMode ? "block" : "none";

            svg.attr("width", width).attr("height", height);
            svg.selectAll("*").remove(); // Clear previous

            // Sankey Layout
            const sankey = d3.sankey()
                .nodeWidth(15)
                .nodePadding(nodePad)
                .extent([[100, 60], [width - 100, height - 20]]) // Increased side margins to fix truncation
                .nodeId(d => d.index); // Use index for linking

            // Deep copy data for layout (d3 modifies it)
            const graph = {
                nodes: sankeyData.nodes.map(d => ({ ...d })),
                links: sankeyData.links.map(d => ({ ...d }))
            };

            sankey(graph);

            // --- Drawing ---

            // 1. Links
            const link = svg.append("g")
                .attr("fill", "none")
                .attr("stroke-opacity", linkOpacity)
                .selectAll("path")
                .data(graph.links)
                .join("path")
                .attr("class", "link")
                .attr("d", d3.sankeyLinkHorizontal())
                .attr("stroke", d => d.source.color)
                .attr("stroke-width", d => Math.max(1, d.width));

            link.append("title").text(d => `${d.source.name} → ${d.target.name}\nValue: ${d.value}`);

            // 2. Nodes
            const node = svg.append("g")
                .selectAll("g")
                .data(graph.nodes)
                .join("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${d.x0},${d.y0})`)
                .call(d3.drag()
                    .subject(d => d)
                    .on("start", function () { this.parentNode.appendChild(this); })
                    .on("drag", dragmod));

            function dragmod(event, d) {
                const rectY = (d.y1 - d.y0);
                // Constrain traversal to height
                d.y0 = Math.max(0, Math.min(height - rectY, event.y));
                d.y1 = d.y0 + rectY;
                d3.select(this).attr("transform", `translate(${d.x0},${d.y0})`);

                // Update layout (recompute links)
                sankey.update(graph);

                // Redraw links
                link.attr("d", d3.sankeyLinkHorizontal());
            }

            // Render Logic: Rects vs Circles
            node.each(function (d) {
                const el = d3.select(this);
                const isGene = d.type === "gene";

                if (fcMode && isGene) {
                    // CIRCLE MODE for Genes
                    const fc = geneFCMap.get(d.name) || 0.5; // Default if missing
                    const radius = Math.min(d.y1 - d.y0, 20) * (0.2 + fc * 0.15); // Scale radius

                    // Adjust vertical center
                    const cy = (d.y1 - d.y0) / 2;

                    el.append("circle")
                        .attr("cx", (d.x1 - d.x0) / 2)
                        .attr("cy", cy)
                        .attr("r", Math.max(3, radius))
                        .attr("fill", d.color);

                } else {
                    // RECT MODE (Default)
                    el.append("rect")
                        .attr("height", d.y1 - d.y0)
                        .attr("width", d.x1 - d.x0)
                        .attr("fill", d.color);
                }
            });

            // Node Labels
            node.append("text")
                .attr("x", d => d.x0 < width / 2 ? (d.x1 - d.x0) + 6 : -6)
                .attr("y", d => (d.y1 - d.y0) / 2)
                .attr("dy", "0.35em")
                .attr("text-anchor", d => d.x0 < width / 2 ? "start" : "end")
                .text(d => d.name)
                .style("fill", d => d.color) // Match text color to node color
                .style("font-size", d => d.type === "gene" && fcMode ? "10px" : "12px");

            // 3. Headers (Manual positioning based on layout)
            const headerG = svg.append("g");
            const xPositions = [0, 0.33 * width, 0.66 * width, width];

            // We can approximate header positions from node columns
            // Identifying x-coords of node groups
            const uniqueX = [...new Set(graph.nodes.map(d => d.x0))].sort((a, b) => a - b);

            if (uniqueX.length >= 4) {
                drawHeader(headerG, uniqueX[0], "Effect", "");
                drawHeader(headerG, uniqueX[1], "Process", "");
                drawHeader(headerG, uniqueX[2], "CellChat Pathway", "(CellChat Pathways)");
                drawHeader(headerG, uniqueX[3], "Gene", "(scRNAseq: Reactome)");
            }
        }

        function drawHeader(g, x, title, sub) {
            g.append("text")
                .attr("class", "column-header")
                .attr("x", x)
                .attr("y", 30)
                .text(title);

            if (sub) {
                g.append("text")
                    .attr("class", "column-sub")
                    .attr("x", x)
                    .attr("y", 45)
                    .text(sub);
            }
        }

        function resizeChart() {
            const height = document.getElementById('chartHeight').value;
            document.getElementById('sankeySvg').style.height = height + 'px';
            updateChart();
        }

        window.addEventListener("resize", updateChart);
        loadData();

    </script>
</body>

</html>